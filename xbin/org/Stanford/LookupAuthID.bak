package org.Stanford;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.net.URISyntaxException;
import java.io.PrintWriter;
import java.util.Properties;
import java.util.Scanner;
import java.sql.*;
import oracle.jdbc.pool.OracleDataSource;
import oracle.jdbc.pool.OracleConnectionCacheManager;

public class LookupAuthID
{
    private static OracleDataSource ods = null;
    public static String result = "";

    public static Connection AuthDBConnection()
    { 
        try
        {
            Properties props = new Properties();
            File inFile = new File(new File(Thread.currentThread().getContextClassLoader().getResource("").toURI()), "conf/server.conf");
            FileInputStream in = new FileInputStream(inFile);
            props.load(in);
            in.close();

            String SERVER = props.getProperty("SERVER");
            String SERVICE_NAME = props.getProperty("SERVICE_NAME");
            String USER = props.getProperty("USER");
            String PASS = props.getProperty("PASS");
            String TABLE_KEY_COL = props.getProperty("KEY_COLUMN");
            String TABLE_ID_COL = props.getProperty("ID_COLUMN");
            String TABLE_NAME = props.getProperty("TABLE_NAME");
            
            Connection connection = null;
            url = "jdbc:oracle:thin:@" + SERVER + ":1521:" + SERVICE_NAME;
            
            ods = new OracleDataSource();
            ods.setURL(url);
            ods.setUser(USER);
            ods.setPassword(PASS);
            ods.setConnectionCachingEnabled(false);
            ods.setConnectionCacheName("CACHE");
            Properties cacheProps = new Properties();
            cacheProps.setProperty("MinLimit", "1");
            cacheProps.setProperty("InitialLimit", "1");
            cacheProps.setProperty("AbandonedConnectionTimeout", "300");
            cacheProps.setProperty("PropertyCheckInterval", "280");
            ods.setConnectionCacheProperties(cacheProps);
            connection = ods.getConnection();

    
    }
    
    public static String LookupAuthIDfromDB(String key)
    {
        String url = "";
        String sql = "";
        String err = "";
        
        try
        {
            Properties props = new Properties();
            File inFile = new File(new File(Thread.currentThread().getContextClassLoader().getResource("").toURI()), "conf/server.conf");
            FileInputStream in = new FileInputStream(inFile);
            props.load(in);
            in.close();

            String SERVER = props.getProperty("SERVER");
            String SERVICE_NAME = props.getProperty("SERVICE_NAME");
            String USER = props.getProperty("USER");
            String PASS = props.getProperty("PASS");
            String TABLE_KEY_COL = props.getProperty("KEY_COLUMN");
            String TABLE_ID_COL = props.getProperty("ID_COLUMN");
            String TABLE_NAME = props.getProperty("TABLE_NAME");
            
            Connection connection = null;
            url = "jdbc:oracle:thin:@" + SERVER + ":1521:" + SERVICE_NAME;
            
            ods = new OracleDataSource();
            ods.setURL(url);
            ods.setUser(USER);
            ods.setPassword(PASS);
            ods.setConnectionCachingEnabled(false);
            ods.setConnectionCacheName("CACHE");
            Properties cacheProps = new Properties();
            cacheProps.setProperty("MinLimit", "1");
            cacheProps.setProperty("InitialLimit", "1");
            cacheProps.setProperty("AbandonedConnectionTimeout", "300");
            cacheProps.setProperty("PropertyCheckInterval", "280");
            ods.setConnectionCacheProperties(cacheProps);
            connection = ods.getConnection();

            sql = "select " + TABLE_ID_COL + " from " + TABLE_NAME + " where " + TABLE_KEY_COL + " = '" + key + "'";
            //sql = "select AUTHORITY_ID from AUTHORITY where AUTHORITY_KEY = '" + key + "'";
            Statement s = null;
            ResultSet rs = null;
            
            s = connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,
                    ResultSet.CONCUR_READ_ONLY);
            rs = s.executeQuery(sql);

            while (rs.next())
            {
                result = rs.getString(1).trim();
            }
            rs.close();
            s.close();

        }
        catch (URISyntaxException e)
        {
            err = e.getMessage();
            return err;
        }
        catch (FileNotFoundException e)
        {
            err = e.getMessage();
            return err + "\nNo server.conf file found.";
        }
        catch (IOException e)
        {
            err = e.getMessage();
            return err + "\nCannot load in server.conf file."; 
        }
        catch(SQLException e)
        {
            err = "SQLException:" + e.getMessage() + "\n" + sql + "\n";
            System.err.println(err);
            return "";
        }
        return result;
    }

};
